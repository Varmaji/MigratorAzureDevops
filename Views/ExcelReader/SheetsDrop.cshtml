@{
        Layout = "~/Views/Shared/_Layout.cshtml";

    }


@model MigratorAzureDevops.Models.sheetList


    
    <link href="../Content/bootstrap.min.css" rel="stylesheet" />
    
    <style>
        .disabled {
            display: none;
        }
    </style>


    <p id="status"></p>

    <div class="col-xs-4">

        @Html.Label("Organization", htmlAttributes: new { @class = "control-label display-4  sizeNormal", style = "padding-right:40px" })

        @Html.DropDownList("Organisation", new SelectList(new[] { "Empty List" }), htmlAttributes: new { @class = "form-control borderRadius width", id = "org", onchange = "check()", style = "opacity:0.8;" })

        @Html.ValidationMessage("Organisation", "", new { @class = "text-danger" })

    </div>
    <div class="form-row">
        <lable>Source Project:</lable><input id="SourceProj" type="text" name="SourceProj" onchange="check()" />
        @*<lable> Destination Project:</lable><input id="DestionationProj" type="text" name="DestionationProj" onchange="check()" />*@

        <div class="col-xs-4 ml-5">

            @Html.Label("Destination Project Name ", htmlAttributes: new { @class = "control-label  display-4 sizeNormal", style = "padding-right:35px" })

            @Html.DropDownList("ProjectName", new SelectList(new[] { "Empty List" }), htmlAttributes: new { @class = "form-control borderRadius width", id = "ProjectName", name = "SourceProj", onchange = "check()", style = "opacity:0.8" })

            @Html.ValidationMessage("ProjectName", "", new { @class = "text-danger" })

        </div>
    </div>
    <div>
        <input type="submit" value="Submit" id="Submit" onclick="check()" class="btn-success form-control" style="margin-right:1220px;" />

    </div>
    <br />

    <div class="col-md-3 dropdowns" style="margin-top:10px">
        <label style="margin-top:20px;">
            <b>
                Sheet Names
            </b>
        </label>
        @Html.DropDownList("sheet", new SelectList(ViewBag.Selectlist, "Value", "Text"), "<select>", new { @class = "form-control", @id = "Sheets", onchange = "Tablechange()" })

    </div>

    <div>
        <table class="table table-bordered" id="tableData">
            <thead>
                <tr id="rowValue">
                    @*<th>Environment Name</th>*@
                    <th align="center">Excel Columns</th>
                    <th align="center">Fields</th>
                </tr>
            </thead>

            <tbody id="body">
            </tbody>
        </table>
    </div>

    <input type="submit" value="Next" id="SubmitButton" onclick="showTableData()" class="btn-success form-control" style="margin-right:1220px;" />




<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
<script>
    alert("hi");
     $(document).ready(function () {
        $.ajax({
            type: 'get',
            dataType: 'json',
            url: '@Url.Action("AccountList","Account")',
            success: function (data) {

                var s = '<option value="0">--Choose Organisation--</option>';
                $("#org").empty();
                console.log(data)
                for (var i = 0; i < data.length; i++) {
                    s += '<option value="' + data[i].accountName + '">' + data[i].accountName + '</option>';
                }
                $("#org").append(s);
            }


        });
         
        $("#org").change(function () {
            $.ajax({
                type: "POST",
                url: '@Url.Action("ProjectList", "Account")',
                data: { "ORG":$(this).val()},
                success:
                    function (data) {
                        console.log(data);
                        document.getElementById("ProjectName").innerHTML = "<option value='0'>--ALL--</option>";
                        for (let i = 0; i < data.length; i++) {
                            document.getElementById("ProjectName").innerHTML += "<option value='" + data[i].Name + "'>" + data[i].Name + "</option>";
                        }
                    }
                ,
                failure:
                    function () { alert("Something went wrong, Please try Again"); }

            });
        });
        function check() {
            console.log($('input[name$="Excel"]').val());
            var a = $('input[name$="Excel"]').val();
            if (a != '') {
                var x = a.split('\\');
                console.log(x);
                $('#ex').html(x[2]);
            }
            if (($('#org').val() == 0) || ($('#ProjectName').val() == 0) || ($('#DestionationProj').val() == 0)) {
                document.getElementById("Submit").disabled = true;

                return;
            }
            document.getElementById("Submit").disabled = false;
        }
     })
    var SourceProj = document.getElementById("ProjectName").val;
    var Organisation = document.getElementById("org").val;
    var DestionationProj = document.getElementById("DestionationProj").val;
    $("#Submit").click(function () {
        $.ajax({
            type: 'get',
            dataType: 'json',
            url: '@Url.Action("AccountList","Account")',
            data: { 'OrganisationName': Organisation, 'SourceProj': SourceProj,'DestionationProj':DestionationProj },
            success: function (data) {
                alert("Select Sheet Name To Continue");
            },
            failure: function () {
                alert("Error Occured To Connect To Project Or You Don't Have Access To Access" + DestionationProj)
            }
    })

</script>
<script>
    var selectedSheet;
    function Tablechange() {
        var selectedSheet = $('#Sheets').val();
        var Dt = JSON.parse(selectedSheet);
        var FieledList = @Html.Raw(Json.Encode(ViewBag.fields));

        $("#table").empty();
        for (let key in Dt[0]) {
            if (Dt[0].hasOwnProperty(key)) {

                var row = "<tr ><td>" + key + "</td><td><select class='list' onchange='DropDownValue(this)'><option value='0'>--Ignore--</option>";
                for (let i = 0; i < FieledList.length; i++) {
                    console.log(FieledList[i].Text);
                    row += "<option value='" + FieledList[i].Text + "'>" + FieledList[i].Text + "</option>";
                }
                row += "</select></td></tr>";
                $("#tableData").append(row);
            }
        }
    }
    var currentval = "";
    function DropDownValue(changed) {
        $('.disabled').removeClass('disabled');
        var val = $(changed).val();

        var list = $('.list');
        var seletlist = [];
        for (let i = 0; i < list.length; i++) {
            var val = $(list[i]).val();
            if (val != '0') {
                seletlist[seletlist.length] = val;
            }
        }

        for (let i = 0; i < list.length; i++) {
            for (let j = 0; j < seletlist.length; j++) {
                var val = $(list[i]).val();
                if (val != seletlist[j]) {
                    var optionlist = $(list[i]).children();
                    for (let i = 0; i < optionlist.length; i++) {
                        if ($(optionlist[i]).val() == seletlist[j]) {
                            $(optionlist[i]).addClass('disabled');
                        }
                    }
                }
            }
        }

    }



    function showTableData() {
        //document.getElementById('info').innerHTML = "";
        var myTab = document.getElementById('tableData');
        var exportData = new Object;
        // LOOP THROUGH EACH ROW OF THE TABLE AFTER HEADER.
        for (i = 1; i < myTab.rows.length; i++) {
            // GET THE CELLS COLLECTION OF THE CURRENT ROW.
            var objCells = myTab.rows.item(i).cells;
            if ($(objCells.item(1).firstChild).val() != "0") {
                var key = (objCells.item(0).innerHTML);
                exportData[key] = $(objCells.item(1).firstChild).val();


                //console.log(obj);
                //exportData.push(obj);
            }
        }
        console.log(exportData);
        var myDictionary = exportData;
        //var selectedSheet = document.getElementById("Sheets");
        var SheetName = $("#Sheets").find("option:selected").text();

        $.ajax({
           type: "POST",
            url: '@Url.Action("createExcel", "ExcelReader")',
            data: { "FList": myDictionary, "SheetName": SheetName },


            success: function (data) {
                alert(data);
                $("#status").html = data;

            }

        });
        console.log(Response);
            ////ajax method
                 // ADD A BREAK (TAG)
    }
</script>
